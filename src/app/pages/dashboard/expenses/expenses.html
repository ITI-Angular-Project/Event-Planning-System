<app-table
  [title]="'Expenses'"
  [subtitle]="'Track and manage event expenses and budgets'"
  [columns]="expensesColumns"
  [data]="expensesData"
  [createButtonText]="'Add Expense'"
  [showFilters]="true"
  [showPagination]="true"
  [filters]="expensesFilters"
  [pageSize]="pageSize"
  [currentPage]="currentPage"
  [totalItems]="totalItems"
  (create)="onCreateExpense()"
  (view)="onViewExpense($event)"
  (edit)="onEditExpense($event)"
  (delete)="onDeleteExpense($event)"
  (search)="onSearchExpenses($event)"
  (filterChange)="onFilterExpenses($event)"
  (pageChange)="onPageChange($event)"
></app-table>

<!-- Totals + Remaining Budget + Doughnut Chart -->
<div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
  <!-- Total & Remaining -->
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 col-span-1">
    <div class="text-sm text-gray-500 dark:text-gray-400">Total Cost</div>
    <div class="text-2xl font-semibold mt-1">{{ totalCost | currency:'USD':'symbol' }}</div>

    <div *ngIf="remainingBudgetEnabled" class="mt-4 space-y-1">
      <div class="text-sm text-gray-500 dark:text-gray-400">
        Budget ({{ selectedEventName || 'Selected Event' }})
      </div>
      <div class="text-xl font-medium mt-1">{{ selectedEventBudget | currency:'USD':'symbol' }}</div>

      <!-- Remaining / Over Budget -->
      <div class="flex items-center gap-2 mt-2">
        <span class="text-sm text-gray-500 dark:text-gray-400">Remaining</span>
        <span
          class="text-xl font-semibold"
          [class.text-green-600]="!overBudget"
          [class.text-red-600]="overBudget"
        >
          {{ (overBudget ? 0 : remainingBudget) | currency:'USD':'symbol' }}
        </span>
      </div>

      <div *ngIf="overBudget" class="text-sm text-red-600">
        Over budget by {{ overBudgetBy | currency:'USD':'symbol' }}
      </div>
    </div>
  </div>

  <!-- Category Totals -->
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 col-span-1">
    <div class="text-sm font-medium text-gray-700 dark:text-gray-200 mb-3">Category Totals</div>
    <ul class="space-y-1 text-sm text-gray-700 dark:text-gray-300">
      <li class="flex justify-between"><span>Venue</span><span>{{ categoryTotals.Venue | currency:'USD':'symbol' }}</span></li>
      <li class="flex justify-between"><span>Decoration</span><span>{{ categoryTotals.Decoration | currency:'USD':'symbol' }}</span></li>
      <li class="flex justify-between"><span>Food</span><span>{{ categoryTotals.Food | currency:'USD':'symbol' }}</span></li>
      <li class="flex justify-between"><span>Music</span><span>{{ categoryTotals.Music | currency:'USD':'symbol' }}</span></li>
      <li class="flex justify-between"><span>Transport</span><span>{{ categoryTotals.Transport | currency:'USD':'symbol' }}</span></li>
      <li class="flex justify-between"><span>Miscellaneous</span><span>{{ categoryTotals.Miscellaneous | currency:'USD':'symbol' }}</span></li>
    </ul>
  </div>

  <!-- Doughnut Chart (ng2-charts) -->
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 col-span-1">
    <div class="text-sm font-medium text-gray-700 dark:text-gray-200 mb-3">
      Category Breakdown ({{ totalCost | currency:'USD':'symbol' }})
    </div>
    <div class="h-60">
      <canvas
        baseChart
        [type]="'doughnut'"
        [data]="doughnutData"
        [options]="doughnutOptions">
      </canvas>
    </div>
    <div *ngIf="doughnutData?.datasets?.[0]?.data?.length === 0" class="text-sm text-gray-500 mt-2">
      No data for selected filters.
    </div>
  </div>
</div>

<!-- CREATE MODAL -->
<app-modal
  [show]="showCreateModal"
  (cancel)="showCreateModal=false"
  [title]="'Add Expense'"
>
  <div class="space-y-4">
    <div>
      <label class="block text-sm font-medium mb-1">Event</label>
      <select class="w-full input" [(ngModel)]="createForm.eventId">
        <option *ngFor="let e of events" [ngValue]="e.id">{{ e.name }}</option>
      </select>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium mb-1">Name</label>
        <input class="w-full input" type="text" [(ngModel)]="createForm.name" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Amount</label>
        <input class="w-full input" type="number" step="0.01" [(ngModel)]="createForm.amount" />
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium mb-1">Category</label>
        <select class="w-full input" [(ngModel)]="createForm.category">
          <option>Venue</option>
          <option>Decoration</option>
          <option>Food</option>
          <option>Music</option>
          <option>Transport</option>
          <option>Miscellaneous</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Date</label>
        <input class="w-full input" type="datetime-local" [(ngModel)]="createForm.date" />
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium mb-1">Notes</label>
      <textarea class="w-full input" rows="3" [(ngModel)]="createForm.notes"></textarea>
    </div>
  </div>

  <div class="mt-6 flex justify-end gap-2">
    <button class="btn-secondary" (click)="showCreateModal=false">Cancel</button>
    <button class="btn-primary" (click)="saveCreate()">Add Expense</button>
  </div>
</app-modal>

<!-- EDIT MODAL -->
<app-modal
  [show]="showEditModal"
  (cancel)="showEditModal=false"
  [title]="'Edit Expense'"
>
  <div class="space-y-4">
    <div>
      <label class="block text-sm font-medium mb-1">Event</label>
      <select class="w-full input" [(ngModel)]="editForm.eventId">
        <option *ngFor="let e of events" [ngValue]="e.id">{{ e.name }}</option>
      </select>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium mb-1">Name</label>
        <input class="w-full input" type="text" [(ngModel)]="editForm.name" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Amount</label>
        <input class="w-full input" type="number" step="0.01" [(ngModel)]="editForm.amount" />
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium mb-1">Category</label>
        <select class="w-full input" [(ngModel)]="editForm.category">
          <option>Venue</option>
          <option>Decoration</option>
          <option>Food</option>
          <option>Music</option>
          <option>Transport</option>
          <option>Miscellaneous</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Date</label>
        <input class="w-full input" type="datetime-local" [(ngModel)]="editForm.date" />
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium mb-1">Notes</label>
      <textarea class="w-full input" rows="3" [(ngModel)]="editForm.notes"></textarea>
    </div>
  </div>

  <div class="mt-6 flex justify-end gap-2">
    <button class="btn-secondary" (click)="showEditModal=false">Cancel</button>
    <button class="btn-primary" (click)="saveEdit()">Save Changes</button>
  </div>
</app-modal>
